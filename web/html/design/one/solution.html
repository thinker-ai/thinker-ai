<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solution</title>
    <link rel="stylesheet" type="text/css" href="../../../static/design/floating-panel.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* 隐藏横向滚动条 */
            width: 95%;
            box-sizing: border-box; /* 确保padding不影响宽度 */
        }
        #content {
            border-top: 1px solid black;
            display: flex;
            margin-top: 10px;
            background-color: #ffffff;
            height: 100vh; /* 设置为视窗高度 */
            box-sizing: border-box;
        }

        #solution-tree {
            width: 30%; /* 左侧占30% */
            margin-top: 10px;
            font-family: Arial, sans-serif;
            border-right: 1px solid #ccc; /* 中间边界线 */
            padding-right: 20px;
            box-sizing: border-box;
        }

        #detail-container {
            width: 70%; /* 右侧占70% */
            padding-left: 20px;
            box-sizing: border-box;
        }
        #editor-container {
            display: flex;
            flex-direction: column;
        }
        #problem-description {
            width: 100%; /* 使得 textarea 宽度占满父容器 */
            height: 200px;
            box-sizing: border-box; /* 包含内边距和边框在宽度计算中 */
            margin-bottom: 10px; /* 可选：为提交按钮留出一点空间 */
            padding: 10px; /* 内边距 */
            border: 1px solid #ccc; /* 边框 */
            border-radius: 4px; /* 圆角边框 */
            resize: none
        }
        #problem{
            padding: 10px;
            width: 100%;
            gap: 10px;
        }
        #problem-label{
            width: 10%;
        }
        #problem-title{
            width: 90%;
        }

        #problem-submit{
            width: 50%;
            align-self: center;
        }
        .tree-node {
            margin-left: 20px;
            cursor: pointer;
        }

        .toggle-symbol {
            font-weight: bold;
            margin-right: 5px;
        }

        .leaf-symbol {
            margin-right: 5px;
        }

        .child-nodes {
            display: block; /* 默认显示子节点 */
            margin-left: 20px;
        }

        .node-text {
            cursor: pointer;
            margin-left: 5px;
        }

        .leaf {
            cursor: default; /* 叶子节点不可折叠 */
        }

        .tree-node.leaf .toggle-symbol {
            visibility: hidden; /* 隐藏叶子节点的加减号 */
        }
    </style>
</head>
<body>
    <div id="editor-container">
        <div id="problem">
            <label id="problem-label">问题标题</label>
            <input id="problem-title" placeholder="请输入问题标题...">
        </div>
        <textarea id="problem-description" placeholder="请输入问题描述..."></textarea>
        <button id="problem-submit" onclick="submitProblem()">提交</button>
    </div>
    <div id="content">
        <div id="solution-tree">
            <!-- 树形结构 -->
        </div>
        <div id="detail-container">
            <!-- 点击目录树节点后在这里显示详情 -->
        </div>
        <div id="floating-panel">
            <div id="chat-container">
                <button id="toggle-button" onclick="toggleFloatingPanel()">+</button>
                <div id="sidebar" onclick="toggleFloatingPanel()">
                    <div class="vertical-text-wrapper">
                        <span class="vertical-text">聊天窗口</span>
                    </div>
                </div>
                <div id="panel-content"> <!-- 新增容器 -->
                    <div id="chat"></div>
                    <div id="input-container">
                        <textarea id="input"></textarea>
                        <div id="button-container">
                            <button id="send" onclick="sendMessage()">
                                <i class="fas fa-paper-plane">发送</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/prism.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript" src="../../../script/common.js"></script>
    <script type="text/javascript" src="../../../script/design/floating-panel.js"></script>
    <script type="text/javascript">
        function submitProblem() {
            const params={
                name:document.getElementById('problem-title').value,
                description:document.getElementById('problem-description').value,
                is_root:true,
            }
             makeRequest(
                {
                    method: 'post',
                    url: '/design/one/solution/generate_state_machine_def',
                    params: params
                },
                {
                    onSuccess: function (clientParams, responseParams) {
                        showPage(responseParams);
                    },
                    onError: function (error) {
                        alert('Error: ' + error.message);
                    },
                    clientParams: {},
                    responseParamsExtractor: function (response) {
                        return response.data;
                    }
                }
            );
        }
        function updateContent(content) {
            // 显示并更新详细内容
            const detailContainer = document.getElementById('detail-container');
            detailContainer.style.display = 'block';
            detailContainer.innerHTML = `<div id="detail-content">${content}</div>`;
        }

        function showData() {
                makeRequest(
                    {
                        method: 'get',
                        url: '/design/one/solution/current',
                        params: {}
                    },
                    {
                        onSuccess: function (clientParams, responseParams) {
                            showPage(responseParams);
                        },
                        onError: function (error) {
                            alert('Error: ' + error.message);
                        },
                        clientParams: {},
                        responseParamsExtractor: function (response) {
                            return response.data;
                        }
                    }
                );
        }
        function showPage(data) {
              showProblem(data);
              showSolution(data);
        }

       function showProblem(data) {
            const problem_title = document.getElementById('problem-title');
            problem_title.value = data.name;

            const problem_description = document.getElementById('problem-description');
            problem_description.value = data.description;
        }

        function showSolution(data) {
            // 假设从服务器获取目录树的 JSON 数据
            const treeData=data.solution_tree
            const solutionTree = document.getElementById('solution-tree');
            solutionTree.innerHTML = ''; // 清空已有的树结构
            // 递归生成树结构
            function createTreeNode(nodeData) {
                const treeNode = document.createElement('div');
                treeNode.className = 'tree-node';

                if (nodeData.children && nodeData.children.length > 0) {
                    // 如果有子节点，添加减号符号，并展开
                    const toggleSymbol = document.createElement('span');
                    toggleSymbol.className = 'toggle-symbol';
                    toggleSymbol.textContent = '-'; // 默认展开
                    toggleSymbol.onclick = function() {
                        toggleNode(toggleSymbol);
                    };
                    treeNode.appendChild(toggleSymbol);

                    const nodeText = document.createElement('span');
                    nodeText.className = 'node-text';
                    nodeText.textContent = nodeData.name;
                    nodeText.onclick = function() {
                        updateContent(nodeData.description);
                    };
                    treeNode.appendChild(nodeText);

                    const childContainer = document.createElement('div');
                    childContainer.className = 'child-nodes';
                    childContainer.style.display = 'block'; // 默认展开子节点

                    nodeData.children.forEach(child => {
                        const childNode = createTreeNode(child);
                        childContainer.appendChild(childNode);
                    });

                    treeNode.appendChild(childContainer);
                } else {
                    // 如果是叶子节点
                    const leafSymbol = document.createElement('span');
                    leafSymbol.className = 'leaf-symbol';
                    leafSymbol.textContent = '•';
                    treeNode.appendChild(leafSymbol);

                    const nodeText = document.createElement('span');
                    nodeText.className = 'node-text';
                    nodeText.textContent = nodeData.name;
                    nodeText.onclick = function() {
                        updateContent(nodeData.description);
                    };
                    treeNode.appendChild(nodeText);
                }

                return treeNode;
            }

            // 创建并添加每个根节点
            treeData.forEach(item => {
                const treeNode = createTreeNode(item);
                solutionTree.appendChild(treeNode);
            });

            // 自动点击第一个节点以显示其内容
            const firstNodeText = solutionTree.querySelector('.tree-node .node-text');
            if (firstNodeText) {
                firstNodeText.click();
            }
        }

        function toggleNode(symbol) {
            const node = symbol.parentElement; // 获取当前节点
            const childNodes = node.querySelector('.child-nodes');

            if (childNodes) {
                if (childNodes.style.display === "none" || childNodes.style.display === "") {
                    childNodes.style.display = "block";
                    symbol.textContent = "-"; // 展开时显示减号
                } else {
                    childNodes.style.display = "none";
                    symbol.textContent = "+"; // 折叠时显示加号
                }
            }
        }
        // 页面加载时自动显示解决方案树和第一个节点的详细信息
        window.onload = showData;
    </script>
</body>
</html>